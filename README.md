# 🕹️ Pygame版 Pac-Man 技術解説（洗練版）

## 1. アーキテクチャ - エンティティ駆動型 & 状態遷移型アーキテクチャ

このPac-Manは、**エンティティ駆動型設計**を基盤としています。  
プレイヤー（Pac-Man）、ゴースト、エサ（ドット）、迷路（Maze）といったゲーム内の構成要素はすべて**独立したクラス**として定義され、それぞれが**個別の状態（位置・速度・色・行動パターンなど）**を保持します。

また、各エンティティは**状態遷移型**の振る舞いを持ち、ゲーム進行に応じてその状態が変化していく仕組みです。  
特にゴーストのAIは、プレイヤー位置や迷路構造に基づいて**リアルタイムに行動を変化**させることで、動的なゲーム体験を実現しています。

## 2. 技術スタック & 描画システム

### 技術スタック
| 要素 | 使用技術 |
|---|---|
| 言語 | Python 3.x |
| ゲームエンジン | Pygame |
| 描画方式 | Surface直接描画 |
| 入力処理 | Pygameイベントハンドラ（キーイベント） |
| 更新方式 | フレームループ（30FPS） |
| サウンド | 必要に応じてPygame.mixer対応可能 |

### 描画システムのポイント
- Pygameの**Surface（仮想キャンバス）**をベースに、毎フレーム全エンティティを再描画。
- 各エンティティ（Pac-Man、ゴースト、ドット）は自身に**`draw()`メソッド**を持ち、描画処理がクラス内にカプセル化。
- ゲーム全体では、**ゲームループ内で一括描画＆画面更新**する構成。

この構造により、描画処理とロジック処理が適切に分離され、メンテナンス性や拡張性を向上。

---

## 3. エンティティ設計 - 役割ごとのクラス設計

### 3-1. Pac-Manクラス（プレイヤーキャラクター）
- 矢印キー入力を**直接監視**して移動方向を制御。
- 移動先が壁なら進行をキャンセル。
- ドットの座標リストを参照し、通過時にドットを消滅。
- **現在座標・移動方向・速度**をクラス内で完全管理。
- 移動ロジックは**迷路クラス**と連携し、壁衝突チェックを外部依存に。

### 3-2. ゴーストクラス（敵キャラクター）
- AIによる**自律移動キャラクター**。
- コンストラクタ引数でAIタイプを指定可能：
    - `chaser`: Pac-Manを**最短経路で追跡**（A*アルゴリズム相当）
    - `random`: 毎フレーム**ランダム方向**に移動
- ゴーストごとに**色・行動パターン**を差別化可能。
- 迷路データを参照し、**行き止まり回避**や**壁衝突対策**も実装。

### 3-3. ドットクラス（エサオブジェクト）
- 迷路全体にドットを配置。
- Pac-Manが通過したドットは即消滅。
- **全ドット座標リスト**を保持し、描画と消滅判定を担当。
- スコア加算処理なども将来的に追加可能。

### 3-4. Mazeクラス（迷路全体管理）
- 迷路の壁配置データ（2Dグリッド）を保持。
- 各マスごとに**通行可能/壁**を判定する関数を提供。
- 全エンティティがこの迷路情報を参照して移動処理を実行。
- **迷路の描画**もMazeクラスが担当し、エンティティとの責務分離。

---

## 4. ゲームロジック & ゴーストAIアルゴリズム

### ゲームループ設計
- 毎フレーム以下の処理を実行：
    1. 入力チェック（Pac-Manの移動方向更新）
    2. 各エンティティの座標更新（移動処理）
    3. Pac-Manとドットの当たり判定（スコア加算・ドット消滅）
    4. Pac-Manとゴーストの衝突判定（ゲームオーバー判定）
    5. 画面全体を再描画（迷路・ドット・キャラ）
    6. 画面更新（`pygame.display.flip()`）
    7. フレームレート制御（30FPS）

---

### ゴーストAI詳細
| AIタイプ | 挙動 |
|---|---|
| Chaser | Pac-Manの現在座標を常に参照し、最短経路を選択 |
| Random | 毎フレーム完全ランダムに進行方向を決定 |
| 将来拡張 | Scatterモード（逃げるAI）、Frightenedモード（パニックAI）等も実装可能 |

ゴーストのAIは、**迷路データを動的に参照**するため、壁の配置変更やステージ切り替えにも柔軟に対応可能。  
今後、パワーエサ（Power Pellet）取得時に「逃げるAI」へ状態遷移する処理も容易に追加可能。

---

## 5. イベント駆動設計 & ユーザーインタラクション

- Pygameの**イベントループ**を活用し、以下の入力処理を実現：
    - 矢印キー：Pac-Manの移動方向更新
    - ウィンドウクローズボタン：ゲーム終了
- 入力処理はPac-Manクラスにカプセル化し、**ユーザー操作とエンティティ状態を分離**。

### ゲーム状態管理
- ゲームオーバー判定は「Pac-Manとゴーストの座標が一定距離内なら終了」として簡潔に実装。
- ゲーム終了後に即終了せず、**リトライ画面表示**や**スコア表示**も拡張可能。

---

## 6. 拡張性とカスタマイズポイント

- 迷路データは外部ファイル（JSONやCSV）に変更可能。
- ゴーストAIにA*アルゴリズムやBFSを導入し、知的な追跡AI実現も可能。
- スコア管理やハイスコア記録も容易に実装可能。
- 複数ステージ（マップ切り替え）対応も、Mazeクラス拡張でスムーズに対応可能。

---

## 7. まとめ

このPygame版Pac-Manは、**エンティティ駆動・状態遷移・AIパターン分離**という3点を軸にした設計です。  
その結果、**描画・入力・AI・ステート管理**が適切に分離され、  
機能追加やAI強化にも耐える柔軟な構造になっています。

今後の拡張要素：
- パワーエサ＆逆襲モード
- ステージセレクト
- ゴーストごとの個性強化
- オンラインランキング対応

Pygameによるレトロゲーム制作の**実践教材**としても最適です。

---

